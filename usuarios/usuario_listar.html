<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Listar Usuários - Gabrielaps</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- PROTEÇÃO DA PÁGINA ---
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Acesso negado. Faça o login primeiro.');
            window.location.href = '../login.html'; // Volta para o login
        }
        // -------------------------

        // Carrega o menu (../ para voltar uma pasta)
        fetch('../menu.html')
            .then(resp => resp.text())
            .then(html => document.getElementById('menu').innerHTML = html);
        
        // Carrega o rodapé (../ para voltar uma pasta)
        fetch('../rodape.html')
            .then(resp => resp.text())
            .then(html => document.getElementById('rodape').innerHTML = html);
    </script>
</head>
<body class="bg-light min-vh-100 d-flex flex-column">
    <div id="menu"></div>

    <main id="principal" class="container-fluid flex-fill d-flex align-items-start justify-content-center py-4">
        <div class="card shadow p-4 w-100" style="max-width: 1000px;">
            <h2 class="mb-4">Usuários - Listar</h2>

            <div class="mb-3">
                <button type="button" class="btn btn-success me-2" onclick="window.location.href='usuario_incluir.html'">
                    Incluir
                </button>
                <button type="button" class="btn btn-warning me-2" onclick="javascript:editar();">
                    Editar
                </button>
                <button type="button" class="btn btn-danger" onclick="javascript:excluir();">
                    Excluir
                </button>
            </div>

            <table class="table table-striped table-hover align-middle">
                <thead class="table-success">
                    <tr>
                        <th scope="col" style="width: 5%;"></th> <th scope="col" style="width: 25%;">ID</th>
                        <th scope="col" style="width: 30%;">Nome</th>
                        <th scope="col"style="width: 25%;">E-mail</th>
                        <th scope="col" style="width: 15%;">Perfil</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo">
                    <tr>
                        <td colspan="5" class="text-center">Carregando usuários...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="rodape"></div>

    <script>
        // URL da API (agora podemos usar caminhos relativos, mas vamos manter o localhost)
        const API_URL = 'https://gabrielaps-backend.onrender.com';

        // --- FUNÇÃO 1: CARREGAR OS USUÁRIOS NA TABELA ---
        async function carregarUsuarios() {
            try {
                const response = await fetch(`${API_URL}/usuarios`, {
                    method: 'GET',
                    headers: {
                        // Poderíamos enviar o token para o backend validar, mas vamos simplificar
                        'Content-Type': 'application/json' 
                    }
                });

                if (!response.ok) {
                    throw new Error('Falha ao carregar dados do servidor.');
                }

                const usuarios = await response.json();
                const tabelaCorpo = document.getElementById('tabela-corpo');
                tabelaCorpo.innerHTML = ''; // Limpa o "Carregando..."

                if (usuarios.length === 0) {
                    tabelaCorpo.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum usuário cadastrado.</td></tr>';
                    return;
                }

                // Preenche a tabela com os dados
                usuarios.forEach(user => {
                    tabelaCorpo.innerHTML += `
                        <tr>
                            <td><input type="checkbox" class="user-check" name="sel[]" value="${user._id}"></td>
                            <td>${user._id}</td> <td>${user.nome}</td>
                            <td>${user.email}</td>
                            <td>${user.perfil}</td>
                        </tr>
                    `;
                });

            } catch (error) {
                alert('Erro ao carregar usuários: ' + error.message);
            }
        }

        // --- FUNÇÃO 2: EDITAR ---
        function editar() {
            const marcados = document.querySelectorAll('input[name="sel[]"]:checked');
            
            if (marcados.length === 0) {
                alert("Selecione UM registro para editar.");
                return;
            }
            if (marcados.length > 1) {
                alert("Selecione APENAS UM registro para editar.");
                return;
            }
            
            // Pega o ID (value) do único item marcado
            const id = marcados[0].value;
            
            // Redireciona para a página de edição (que vamos criar)
            // passando o ID pela URL
            window.location.href = `usuario_editar.html?id=${id}`; 
        }

        // --- FUNÇÃO 3: EXCLUIR ---
        async function excluir() {
            const marcados = document.querySelectorAll('input[name="sel[]"]:checked');
            
            if (marcados.length === 0) {
                alert("Selecione pelo menos um registro para excluir.");
                return;
            }
            
            // Pega o ID do PRIMEIRO marcado (vamos fazer exclusão de um por um)
            // Um sistema real faria um loop ou mandaria um array de IDs
            const id = marcados[0].value;
            const nome = marcados[0].closest('tr').cells[2].innerText; // Pega o nome na tabela

            if (confirm(`Tem certeza que deseja excluir o usuário "${nome}" (ID: ${id})?`)) {
                try {
                    const response = await fetch(`${API_URL}/usuarios/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('Usuário excluído com sucesso!');
                        carregarUsuarios(); // Recarrega a tabela
                    } else {
                        alert('Falha ao excluir: ' + data.message);
                    }
                } catch (error) {
                    alert('Erro na conexão ao excluir: ' + error.message);
                }
            }
        }

        // --- RODA A FUNÇÃO 1 QUANDO A PÁGINA TERMINA DE CARREGAR ---
        document.addEventListener('DOMContentLoaded', carregarUsuarios);
    </script>
</body>
</html>